{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ezekiel.mogaka/Desktop/Code/radio-globe-next/apps/web/src/app/api/radio-browser/route.ts"],"sourcesContent":["/**\n * Radio Browser API Proxy\n * \n * Proxies requests to the Radio Browser API to:\n * 1. Avoid CORS issues on the client\n * 2. Add caching headers\n * 3. Handle rate limiting\n * 4. Provide a consistent API interface\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\n\n// Radio Browser API servers\nconst API_SERVERS = [\n  \"https://de1.api.radio-browser.info\",\n  \"https://nl1.api.radio-browser.info\",\n  \"https://at1.api.radio-browser.info\",\n];\n\nlet currentServerIndex = 0;\n\nfunction getNextServer(): string {\n  const server = API_SERVERS[currentServerIndex];\n  currentServerIndex = (currentServerIndex + 1) % API_SERVERS.length;\n  return server;\n}\n\n// Try fetching from a specific server with timeout\nasync function fetchWithTimeout(url: string, timeout = 5000): Promise<Response> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\n  \n  try {\n    const response = await fetch(url, {\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"User-Agent\": \"RadioGlobe/1.0 (https://radio-globe.app)\",\n      },\n      signal: controller.signal,\n    });\n    clearTimeout(timeoutId);\n    return response;\n  } catch (error) {\n    clearTimeout(timeoutId);\n    throw error;\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get the path from the query params\n    const { searchParams } = new URL(request.url);\n    const path = searchParams.get(\"path\");\n\n    if (!path) {\n      return NextResponse.json(\n        { error: \"Missing 'path' parameter\" },\n        { status: 400 }\n      );\n    }\n\n    // Try each server until one succeeds\n    let lastError: Error | null = null;\n    \n    for (let i = 0; i < API_SERVERS.length; i++) {\n      const baseUrl = getNextServer();\n      const targetUrl = new URL(path, baseUrl);\n\n      // Forward all other query params\n      searchParams.forEach((value, key) => {\n        if (key !== \"path\") {\n          targetUrl.searchParams.append(key, value);\n        }\n      });\n\n      try {\n        console.log(`[Radio Browser Proxy] Trying: ${targetUrl.toString()}`);\n\n        const response = await fetchWithTimeout(targetUrl.toString(), 5000);\n\n        if (!response.ok) {\n          console.warn(`[Radio Browser Proxy] Server ${baseUrl} returned ${response.status}`);\n          lastError = new Error(`Upstream error: ${response.statusText}`);\n          continue;\n        }\n\n        const data = await response.json();\n\n        // Return with cache headers\n        return NextResponse.json(data, {\n          headers: {\n            \"Cache-Control\": \"public, s-maxage=300, stale-while-revalidate=600\",\n            \"X-Radio-Browser-Server\": baseUrl,\n          },\n        });\n      } catch (fetchError) {\n        console.warn(`[Radio Browser Proxy] Server ${baseUrl} failed:`, (fetchError as Error).message);\n        lastError = fetchError as Error;\n        continue;\n      }\n    }\n\n    // All servers failed - return empty array instead of error for graceful degradation\n    console.error(`[Radio Browser Proxy] All servers failed. Last error:`, lastError?.message);\n    return NextResponse.json([], {\n      headers: {\n        \"Cache-Control\": \"public, s-maxage=60\",\n      },\n    });\n  } catch (error) {\n    console.error(\"[Radio Browser Proxy] Error:\", error);\n    // Return empty array for graceful degradation\n    return NextResponse.json([], {\n      headers: {\n        \"Cache-Control\": \"public, s-maxage=60\",\n      },\n    });\n  }\n}\n\n// Handle POST requests (for station clicks/votes)\nexport async function POST(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const path = searchParams.get(\"path\");\n\n    if (!path) {\n      return NextResponse.json(\n        { error: \"Missing 'path' parameter\" },\n        { status: 400 }\n      );\n    }\n\n    const baseUrl = getNextServer();\n    const targetUrl = new URL(path, baseUrl);\n\n    const response = await fetch(targetUrl.toString(), {\n      method: \"GET\", // Radio Browser uses GET even for clicks/votes\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"User-Agent\": \"RadioGlobe/1.0 (https://radio-globe.app)\",\n      },\n    });\n\n    if (!response.ok) {\n      return NextResponse.json(\n        { error: `Upstream error: ${response.statusText}` },\n        { status: response.status }\n      );\n    }\n\n    const data = await response.json();\n    return NextResponse.json(data);\n  } catch (error) {\n    console.error(\"[Radio Browser Proxy] POST Error:\", error);\n    return NextResponse.json(\n      { error: \"Failed to process request\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["API_SERVERS","currentServerIndex","getNextServer","server","length","fetchWithTimeout","url","timeout","controller","AbortController","timeoutId","setTimeout","abort","response","fetch","method","headers","signal","clearTimeout","error","GET","request","searchParams","URL","path","get","json","status","lastError","i","baseUrl","targetUrl","forEach","value","key","append","console","log","toString","ok","warn","Error","statusText","data","fetchError","message","POST"],"mappings":"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"}}]
}