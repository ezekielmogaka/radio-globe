{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/ezekiel.mogaka/Desktop/Code/radio-globe-next/apps/web/src/app/api/stations/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport fs from 'fs';\nimport path from 'path';\n\nconst CACHE_FILE = path.join(process.cwd(), 'data', 'stations-cache.json');\nconst CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours\n\ninterface CacheData {\n  stations: any[];\n  timestamp: number;\n  version: string;\n}\n\n/**\n * GET /api/stations - Returns cached stations or fetches fresh data\n */\nexport async function GET() {\n  try {\n    // Check if cache file exists and is fresh\n    if (fs.existsSync(CACHE_FILE)) {\n      const cacheData: CacheData = JSON.parse(fs.readFileSync(CACHE_FILE, 'utf-8'));\n      const age = Date.now() - cacheData.timestamp;\n\n      // Return cache if fresh\n      if (age < CACHE_DURATION) {\n        console.log(`Serving ${cacheData.stations.length} stations from cache (age: ${Math.round(age / 1000 / 60)} min)`);\n        return NextResponse.json({\n          stations: cacheData.stations,\n          cached: true,\n          timestamp: cacheData.timestamp,\n          count: cacheData.stations.length,\n        });\n      }\n\n      // Cache is stale, trigger background refresh but return stale data\n      console.log('Cache stale, triggering background refresh...');\n      refreshCacheInBackground();\n      \n      return NextResponse.json({\n        stations: cacheData.stations,\n        cached: true,\n        stale: true,\n        timestamp: cacheData.timestamp,\n        count: cacheData.stations.length,\n      });\n    }\n\n    // No cache exists, fetch fresh data\n    console.log('No cache found, fetching fresh data...');\n    const stations = await fetchAndCacheStations();\n    \n    return NextResponse.json({\n      stations,\n      cached: false,\n      timestamp: Date.now(),\n      count: stations.length,\n    });\n  } catch (error) {\n    console.error('Error in /api/stations:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch stations' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/stations/refresh - Force refresh cache\n */\nexport async function POST() {\n  try {\n    console.log('Manual refresh requested...');\n    const stations = await fetchAndCacheStations();\n    \n    return NextResponse.json({\n      success: true,\n      count: stations.length,\n      timestamp: Date.now(),\n    });\n  } catch (error) {\n    console.error('Error refreshing cache:', error);\n    return NextResponse.json(\n      { error: 'Failed to refresh cache' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Fetch stations from Radio Browser API and cache to JSON file\n */\nasync function fetchAndCacheStations(): Promise<any[]> {\n  const baseUrl = 'https://de1.api.radio-browser.info/json';\n  \n  console.log('Fetching stations from Radio Browser API...');\n  const response = await fetch(\n    `${baseUrl}/stations?limit=50000&hidebroken=true&order=clickcount&reverse=true`\n  );\n\n  if (!response.ok) {\n    throw new Error('Failed to fetch from Radio Browser API');\n  }\n\n  const stations = await response.json();\n  console.log(`Fetched ${stations.length} stations from API`);\n\n  // Ensure data directory exists\n  const dataDir = path.dirname(CACHE_FILE);\n  if (!fs.existsSync(dataDir)) {\n    fs.mkdirSync(dataDir, { recursive: true });\n  }\n\n  // Save to cache file\n  const cacheData: CacheData = {\n    stations,\n    timestamp: Date.now(),\n    version: '1.0.0',\n  };\n\n  fs.writeFileSync(CACHE_FILE, JSON.stringify(cacheData, null, 2));\n  console.log(`Cached ${stations.length} stations to ${CACHE_FILE}`);\n\n  return stations;\n}\n\n/**\n * Background refresh (non-blocking)\n */\nfunction refreshCacheInBackground() {\n  fetchAndCacheStations().catch(err => {\n    console.error('Background refresh failed:', err);\n  });\n}\n"],"names":["CACHE_FILE","join","process","cwd","CACHE_DURATION","GET","existsSync","cacheData","JSON","parse","readFileSync","age","Date","now","timestamp","console","log","stations","length","Math","round","json","cached","count","refreshCacheInBackground","stale","fetchAndCacheStations","error","status","POST","success","baseUrl","response","fetch","ok","Error","dataDir","dirname","mkdirSync","recursive","version","writeFileSync","stringify","catch","err"],"mappings":"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"}}]
}